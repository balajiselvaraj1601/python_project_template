# ==========================================================================
# Justfile for {{ project_name }}
#
# Usage:
#   just            # list commands
#   just ci         # run full CI locally
#   just test       # run tests
# ==========================================================================

# Always show commands if no recipe is given
default:
    @just --list

# -------------------------------------------------------------------------
# Helpers (private)
# -------------------------------------------------------------------------

_set_env:
    @echo "Using Python >= {{ python_min_version }}"
    @uv --version > /dev/null

# -------------------------------------------------------------------------
# Formatting & Linting
# -------------------------------------------------------------------------

fmt:
    @uv run ruff format .

lint:
    @uv run ruff check .

fix:
    @uv run ruff check --fix .

# -------------------------------------------------------------------------
# Type checking
# -------------------------------------------------------------------------

type:
    @uv run basedpyright

# -------------------------------------------------------------------------
# Testing
# -------------------------------------------------------------------------

test:
    @uv run pytest tests/ -v

test-parallel:
    @uv run pytest tests/ -v -n auto

coverage:
    @uv run pytest tests/ \
        --cov=src \
        --cov-report=term-missing \
        --cov-report=html \
        --cov-report=xml

# -------------------------------------------------------------------------
# Pre-commit
# -------------------------------------------------------------------------

precommit-install:
    @uv run pre-commit install
    @uv run pre-commit install --hook-type pre-push

precommit:
    @uv run pre-commit run --all-files --verbose

# -------------------------------------------------------------------------
# Dependency management
# -------------------------------------------------------------------------

sync:
    @uv sync

update:
    @uv lock --upgrade
    @uv sync

# -------------------------------------------------------------------------
# Docs (optional)
# -------------------------------------------------------------------------
{% if include_docs %}
docs-serve:
    @uv run mkdocs serve

docs-build:
    @uv run mkdocs build

docs-deploy:
    @uv run mkdocs gh-deploy --force
{% endif %}

# -------------------------------------------------------------------------
# Build & Publish
# -------------------------------------------------------------------------

build:
    @uv build

publish:
    @uv publish

# -------------------------------------------------------------------------
# Cleaning
# -------------------------------------------------------------------------

clean:
    @rm -rf build/ dist/ *.egg-info
    @rm -rf .pytest_cache .ruff_cache .coverage htmlcov
    @find . -type d -name "__pycache__" -exec rm -rf {} +
    @find . -type f -name "*.pyc" -delete

# -------------------------------------------------------------------------
# CI (local mirror of GitHub Actions)
# -------------------------------------------------------------------------

ci:
    @just lint
    @just type
    @just test
    @just precommit

# -------------------------------------------------------------------------
# Doctor / Diagnostics
# -------------------------------------------------------------------------

doctor:
    @echo "=== Environment ==="
    @python --version
    @uv --version
    @echo ""
    @echo "=== Tools ==="
    @uv run ruff --version
    @uv run basedpyright --version || echo "basedpyright not installed"
    @uv run pytest --version
    @echo ""
    @echo "=== Project ==="
    @echo "Package: {{ package_name }}"
    @echo "Python: >= {{ python_min_version }}"
